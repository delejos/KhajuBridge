# Option A — Dedicated IP Deployment (Strict Iran-Only)

This document describes **Option A**, an advanced KhajuBridge deployment mode that enforces **strict Iran-only access** by giving Psiphon Conduit a **dedicated network identity**.

Option A builds on KhajuBridge’s default firewall model and is intended for operators who require **hard regional exclusivity**, not just optimization.

---

## When You Need Option A

Use Option A if **any** of the following are true:

- You must guarantee that the Conduit service is **logically Iran-only**
- You want Conduit traffic to have a **distinct IP identity**
- You want to prevent accidental or structural regional bypass
- You are operating a shared host with multiple services
- You need strong, auditable network-layer enforcement

If you only want to **improve Conduit reliability** under Iranian network conditions, **Option A is not required**.  
The default KhajuBridge deployment (Layer 1) is sufficient in most cases.

---

## Why a Dedicated IP Is Required

Psiphon Conduit:

- Is outbound-only
- Does not bind to a specific local IP
- Does not expose a fixed listening port
- Uses NAT traversal and broker connections

Because of this, **process-scoped firewall rules alone cannot provide a distinct network identity** for Conduit.

Without Option A:

- Conduit shares the host’s primary IP
- “Iran-only” cannot be enforced as a hard invariant

Option A solves this by enforcing identity at the **network layer**, not the application layer.

---

## Design Overview

Option A introduces three components:

1. **Dedicated Local IP**
   - A secondary IP address assigned to the host
   - Used exclusively as Conduit’s network identity

2. **Source NAT (SNAT)**
   - All traffic generated by the Conduit service is rewritten
   - Outbound packets appear to originate from the dedicated IP

3. **IP-Scoped Firewall Rules**
   - Only Iranian CIDR ranges are allowed to interact with the dedicated IP
   - All other sources are dropped

Conduit itself is **not modified**.

---

## Architecture Diagram (Conceptual)

Conduit process
↓
systemd cgroup
↓
SNAT (force source = dedicated IP)
↓
Firewall rules scoped to dedicated IP
↓
Internet (Iran-only)


---

## Prerequisites

- KhajuBridge installed and working in default mode
- Psiphon Conduit running as a systemd service (`conduit.service`)
- nftables enabled
- Ability to assign a secondary local IP
- Root or sudo access

---

## Installation

### 1. Assign a Dedicated Local IP

**Example only — replace with values appropriate for your environment:**

bash
sudo ip addr add <DEDICATED_IP>/<PREFIX> dev <INTERFACE>
Example (documentation-only):

sudo ip addr add 192.0.2.20/24 dev eth0
This IP should be used only for Conduit.

2. Force Conduit Traffic to Use the Dedicated IP (SNAT)
Determine the UID of the Conduit service:

id -u conduit
Create the NAT table and rule:

CONDUIT_UID=$(id -u conduit)

sudo nft add table ip conduit_nat
sudo nft 'add chain ip conduit_nat postrouting { type nat hook postrouting priority srcnat; policy accept; }'
sudo nft add rule ip conduit_nat postrouting meta skuid $CONDUIT_UID snat to <DEDICATED_IP>
This ensures all outbound Conduit traffic uses the dedicated IP.

3. Enforce Iran-Only Access to the Dedicated IP
Assumes an existing nftables set @region_ipv4 managed by KhajuBridge.

# Allow Iran → dedicated IP
sudo nft add rule inet khajubridge input \
  ip daddr <DEDICATED_IP> \
  ip saddr @region_ipv4 \
  accept

# Drop all other traffic to the dedicated IP
sudo nft add rule inet khajubridge input \
  ip daddr <DEDICATED_IP> \
  counter drop
No LAN exceptions are enabled in strict mode.

4. Persist the Configuration
sudo sh -c 'nft list ruleset > /etc/nftables.conf'
sudo systemctl enable nftables
sudo systemctl restart nftables
Verification
Confirm Conduit Uses the Dedicated IP
sudo systemctl restart conduit
sudo timeout 10 tcpdump -ni <INTERFACE> \
  'src host <DEDICATED_IP> and tcp port 443'
Expected output:

<DEDICATED_IP> → <remote>:443
Confirm Rules Are Loaded
sudo nft list ruleset
sudo nft list chain ip conduit_nat postrouting

---

## Operational Notes

Option A does not require port forwarding
Option A does not expose new listening services
Option A affects only the Conduit service
Other system traffic remains unchanged
IPv6 is not covered by default

---

## Rollback (Emergency Use)

⚠️ These commands are for emergency recovery or debugging only.

Full Rollback (Blunt)
sudo nft delete table ip conduit_nat
sudo nft flush chain inet khajubridge input
sudo systemctl restart nftables
This removes all Option A logic and restores unrestricted networking.

Safer Rollback Options
Disable SNAT Only (Keep Firewall)
sudo nft delete table ip conduit_nat
sudo sh -c 'nft list ruleset > /etc/nftables.conf'
sudo systemctl restart nftables
Effect:

Conduit reverts to the primary IP

Iran-only rules remain but no longer match Conduit traffic

Temporary Allow-All (Without Deleting Rules)
sudo nft add rule inet khajubridge input \
  ip daddr <DEDICATED_IP> \
  accept
Remove later by rule handle.

---

## Summary

Option A provides:

Strong Iran-only enforcement
A distinct network identity for Conduit
No changes to Conduit itself
Auditable, reversible firewall logic
Option A is not required for most deployments, but is recommended where strict regional exclusivity is a hard requirement.
For general optimization and reliability, use KhajuBridge’s default deployment (Layer 1).
